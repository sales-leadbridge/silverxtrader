<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SilverX Elite AI | Institutional Terminal</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.emailjs.com/sdk/2.3.2/email.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --royal-blue: #2563eb;
            --deep-dark: #0f172a;
            --gold: #fbbf24;
            --neon-cyan: #06b6d4;
            --danger: #ef4444;
            --success: #22c55e;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- MATRIX ANIMATION & SIGNAL BOX --- */
        .ai-chamber {
            position: relative;
            height: 140px;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #334155;
        }

        .matrix-lines {
            position: absolute;
            inset: 0;
            background-image: linear-gradient(0deg, transparent 24%, rgba(6, 182, 212, .05) 25%, rgba(6, 182, 212, .05) 26%, transparent 27%, transparent 74%, rgba(6, 182, 212, .05) 75%, rgba(6, 182, 212, .05) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(6, 182, 212, .05) 25%, rgba(6, 182, 212, .05) 26%, transparent 27%, transparent 74%, rgba(6, 182, 212, .05) 75%, rgba(6, 182, 212, .05) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
            animation: matrixMove 20s linear infinite;
        }

        @keyframes matrixMove {
            0% { background-position: 0 0; }
            100% { background-position: 50px 50px; }
        }

        .neon-swirl {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: var(--neon-cyan);
            border-bottom-color: var(--royal-blue);
            animation: spin 3s linear infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.3);
        }

        .neon-swirl::before {
            content: '';
            position: absolute;
            inset: 10px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-left-color: var(--gold);
            border-right-color: var(--danger);
            animation: spinReverse 5s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes spinReverse { 100% { transform: rotate(-360deg); } }

        /* --- 3D BUTTONS --- */
        .btn-3d {
            transition: all 0.1s;
            border-bottom: 4px solid rgba(0,0,0,0.2);
            active: translateY(2px);
        }
        .btn-3d:active {
            transform: translateY(3px);
            border-bottom-width: 1px;
        }

        /* --- OVERLAYS & MODALS --- */
        .full-screen-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: #ffffff;
            z-index: 99999;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .ad-overlay-container {
            display: none;
            position: fixed;
            inset: 0;
            background: #ffffff;
            z-index: 100000;
            flex-direction: column;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed;
            left: -100%;
            top: 0;
            bottom: 0;
            width: 80%;
            max-width: 300px;
            background: white;
            z-index: 50000;
            box-shadow: 10px 0 30px rgba(0,0,0,0.1);
            transition: 0.3s ease-in-out;
            padding: 25px;
        }
        .sidebar.active { left: 0; }
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 40000;
        }

        /* --- STATUS BADGES --- */
        .status-free { color: #94a3b8; background: #f1f5f9; }
        .status-vip { color: #713f12; background: #fef08a; border: 1px solid #fbbf24; }

        /* --- CARD FEEDBACK --- */
        .signal-buy { border-color: var(--success) !important; background-color: #f0fdf4 !important; }
        .signal-sell { border-color: var(--danger) !important; background-color: #fef2f2 !important; }
    </style>
</head>
<body>

    <div id="ad-layer" class="ad-overlay-container">
        <div class="flex justify-between items-center p-3 bg-slate-900 text-white shadow-md">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                <span class="text-xs font-bold">SPONSORED AD</span>
            </div>
            <div class="flex items-center gap-3">
                <span id="ad-timer" class="bg-slate-700 px-3 py-1 rounded-full text-xs font-bold text-yellow-400">WAIT: 20s</span>
                <button id="ad-close-btn" onclick="closeAd()" class="hidden text-white hover:text-red-400 text-xl"><i class="fas fa-times-circle"></i></button>
            </div>
        </div>
        <iframe id="ad-frame" src="" class="w-full flex-grow border-0" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
    </div>

    <div id="side-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div id="app-sidebar" class="sidebar">
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-2">
                <i class="fas fa-cube text-blue-600 text-2xl"></i>
                <h2 class="font-black text-xl tracking-tighter">MENU</h2>
            </div>
            <button onclick="toggleSidebar()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="space-y-3">
            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Signed in as</p>
                <p id="menu-email" class="text-xs font-bold truncate">...</p>
            </div>

            <a href="https://wa.me/923064391353" class="flex items-center gap-3 p-4 rounded-xl font-bold text-sm bg-green-50 text-green-700 hover:bg-green-100 transition"><i class="fab fa-whatsapp text-lg"></i> Help Center</a>
            <a href="https://www.tiktok.com/@kingtraderofficail" class="flex items-center gap-3 p-4 rounded-xl font-bold text-sm bg-slate-50 text-slate-700 hover:bg-slate-100 transition"><i class="fab fa-tiktok text-lg"></i> TikTok Bot</a>
            <a href="https://www.youtube.com/@kingtraderofficial45" class="flex items-center gap-3 p-4 rounded-xl font-bold text-sm bg-red-50 text-red-700 hover:bg-red-100 transition"><i class="fab fa-youtube text-lg"></i> YouTube</a>
            
            <div class="h-px bg-slate-100 my-4"></div>
            
            <button onclick="auth.signOut()" class="w-full p-4 rounded-xl font-black text-sm bg-slate-900 text-white shadow-lg btn-3d">LOGOUT</button>
        </div>
    </div>

    <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm">
        <div class="max-w-md mx-auto p-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center border-2 border-amber-400 shadow-lg">
                    <i id="vip-icon" class="fas fa-crown text-amber-400 text-lg"></i>
                </div>
                <div>
                    <h1 class="font-black text-lg leading-tight text-slate-800">SILVERX <span class="text-blue-600">AI</span></h1>
                    <p class="text-[9px] font-bold text-slate-400 tracking-wider">ELITE TERMINAL</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="live-clock" class="bg-slate-100 px-3 py-1.5 rounded-lg text-[10px] font-black font-mono text-slate-600">00:00:00</div>
                <button onclick="toggleSidebar()" class="text-2xl text-slate-700"><i class="fas fa-bars-staggered"></i></button>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 pb-20">
        
        <div class="bg-slate-900 rounded-[30px] p-6 text-white mb-6 shadow-xl relative overflow-hidden">
            <div class="absolute -right-10 -top-10 w-32 h-32 bg-blue-600 rounded-full opacity-20 blur-2xl"></div>
            <div class="relative z-10">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-1">Current Balance</p>
                        <h2 class="text-4xl font-black tracking-tight"><span id="pts">0</span> <span class="text-base font-bold opacity-60">PTS</span></h2>
                    </div>
                    <span id="tier-badge" class="px-3 py-1 rounded-full text-[10px] font-black uppercase status-free">FREE</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="handleWithdraw()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl text-xs font-black uppercase btn-3d">Withdraw</button>
                    <button onclick="openModal('vip-page')" class="flex-1 bg-amber-400 hover:bg-amber-300 text-slate-900 py-3 rounded-xl text-xs font-black uppercase btn-3d"><i class="fas fa-bolt"></i> Go VIP</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="openModal('recovery-page')" class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 btn-3d">
                <i class="fas fa-chart-line text-2xl text-orange-500"></i>
                <span class="text-xs font-black text-slate-700">RECOVERY</span>
            </button>
            <a href="https://broker-qx.pro/sign-up/?lid=1696715" target="_blank" class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 btn-3d">
                <i class="fas fa-arrow-trend-up text-2xl text-green-500"></i>
                <span class="text-xs font-black text-slate-700">JOIN QUOTEX</span>
            </a>
            <a href="https://po-ru4.click/register?utm_campaign=835777&utm_source=affiliate&utm_medium=sr&a=JbsX5mZ1ZchgeZ&ac=pak_users_2026" target="_blank" class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 btn-3d">
                <i class="fas fa-wallet text-2xl text-blue-500"></i>
                <span class="text-xs font-black text-slate-700">POCKET JOIN</span>
            </a>
            <button onclick="openModal('policy-page')" class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 btn-3d">
                <i class="fas fa-shield-halved text-2xl text-purple-500"></i>
                <span class="text-xs font-black text-slate-700">POLICY</span>
            </button>
        </div>

        <div class="p-1 bg-slate-200 rounded-2xl flex mb-6">
            <button id="tab-qx" onclick="switchTab('qx')" class="flex-1 py-3 rounded-xl text-xs font-black transition-all bg-white shadow-sm text-slate-800">QUOTEX BOT</button>
            <button id="tab-po" onclick="switchTab('po')" class="flex-1 py-3 rounded-xl text-xs font-black transition-all text-slate-500">POCKET BOT</button>
        </div>

        <div id="qx-grid" class="space-y-5"></div>
        <div id="po-grid" class="space-y-5 hidden"></div>
        
    </main>

    <div id="policy-page" class="full-screen-modal">
        <div class="sticky top-0 bg-white p-5 border-b flex items-center gap-4 z-50">
            <button onclick="closeModal('policy-page')" class="text-xl text-slate-400"><i class="fas fa-arrow-left"></i></button>
            <h2 class="font-black text-xl text-slate-800">Privacy & Terms</h2>
        </div>
        <div class="p-5 space-y-4">
            <div id="policy-content"></div> </div>
    </div>

    <div id="vip-page" class="full-screen-modal">
        <div class="sticky top-0 bg-white p-5 border-b flex items-center gap-4 z-50">
            <button onclick="closeModal('vip-page')" class="text-xl text-slate-400"><i class="fas fa-arrow-left"></i></button>
            <h2 class="font-black text-xl text-slate-800">VIP Access</h2>
        </div>
        <div class="p-5">
            <div class="bg-amber-50 border border-amber-100 p-6 rounded-3xl text-center mb-6">
                <i class="fas fa-crown text-4xl text-amber-500 mb-3 animate-bounce"></i>
                <h3 class="font-black text-2xl text-amber-600 mb-1">$100 / Month</h3>
                <p class="text-xs font-bold text-amber-400/80 uppercase">Ultimate Trading Power</p>
            </div>
            
            <h4 class="font-black text-sm text-slate-400 mb-4 uppercase tracking-widest">VIP Benefits</h4>
            <div id="vip-rules-content" class="space-y-3 mb-8"></div> <button onclick="openPayment('VIP_ACCESS', 100)" class="w-full py-4 bg-slate-900 text-amber-400 rounded-2xl font-black text-sm btn-3d shadow-xl shadow-amber-100">
                ACTIVATE VIP NOW
            </button>
        </div>
    </div>

    <div id="recovery-page" class="full-screen-modal">
        <div class="sticky top-0 bg-white p-5 border-b flex items-center gap-4 z-50">
            <button onclick="closeModal('recovery-page')" class="text-xl text-slate-400"><i class="fas fa-arrow-left"></i></button>
            <h2 class="font-black text-xl text-slate-800">Recovery Hub</h2>
        </div>
        <div class="p-5">
            <h4 class="font-black text-sm text-slate-400 mb-4 uppercase tracking-widest">How it Works</h4>
            <div id="rec-rules-content" class="space-y-3 mb-8"></div> <h4 class="font-black text-sm text-slate-400 mb-4 uppercase tracking-widest">Select Plan</h4>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="checkRecovery(10)" class="p-4 border-2 border-slate-100 rounded-2xl flex justify-between items-center hover:border-blue-500 transition btn-3d bg-white">
                    <span class="font-black text-slate-700">$10 PLAN</span>
                    <span class="text-xs font-bold text-green-500 bg-green-50 px-2 py-1 rounded">+5% GROW</span>
                </button>
                <div class="relative">
                    <button onclick="checkRecovery(20)" class="w-full p-4 border-2 border-slate-100 rounded-2xl flex justify-between items-center hover:border-blue-500 transition btn-3d bg-white">
                        <span class="font-black text-slate-700">$20 PLAN</span>
                        <span class="text-xs font-bold text-green-500 bg-green-50 px-2 py-1 rounded">+10% GROW</span>
                    </button>
                    <div id="vip-free-badge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-[9px] font-black px-2 py-0.5 rounded-full shadow-sm animate-pulse">FREE FOR VIP</div>
                </div>
                <button onclick="checkRecovery(50)" class="p-4 border-2 border-slate-100 rounded-2xl flex justify-between items-center hover:border-blue-500 transition btn-3d bg-white">
                    <span class="font-black text-slate-700">$50 PLAN</span>
                    <span class="text-xs font-bold text-green-500 bg-green-50 px-2 py-1 rounded">+30% GROW</span>
                </button>
                <button onclick="checkRecovery(100)" class="p-4 border-2 border-slate-100 rounded-2xl flex justify-between items-center hover:border-blue-500 transition btn-3d bg-white">
                    <span class="font-black text-slate-700">$100 PLAN</span>
                    <span class="text-xs font-bold text-green-500 bg-green-50 px-2 py-1 rounded">+70% GROW</span>
                </button>
            </div>
        </div>
    </div>

    <div id="payment-page" class="full-screen-modal bg-slate-50">
        <div class="sticky top-0 bg-slate-50 p-5 flex items-center gap-4 z-50">
            <button onclick="closeModal('payment-page')" class="text-xl text-slate-400"><i class="fas fa-arrow-left"></i></button>
            <h2 class="font-black text-xl text-slate-800">Secure Payment</h2>
        </div>
        <div class="p-5">
            <div class="bg-white p-6 rounded-[30px] shadow-xl text-center">
                <p id="pay-plan-name" class="text-xs font-bold text-blue-500 uppercase tracking-widest mb-1">VIP ACCESS</p>
                <h3 id="pay-amount" class="text-3xl font-black text-slate-800 mb-6">$100.00</h3>
                
                <div class="space-y-4 text-left">
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <div class="flex justify-between mb-1"><span class="text-[10px] font-bold text-slate-400">USDT TRC20</span> <i class="far fa-copy text-blue-500"></i></div>
                        <p class="text-[11px] font-black break-all text-slate-700">TGzsm8guzbaBsbNa9JLPR3WTRzFRy6B6FG</p>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <div class="flex justify-between mb-1"><span class="text-[10px] font-bold text-slate-400">BINANCE PAY ID</span> <i class="far fa-copy text-blue-500"></i></div>
                        <p class="text-sm font-black text-slate-700">403009858</p>
                    </div>
                </div>

                <div class="mt-6 border-2 border-dashed border-slate-200 p-4 rounded-2xl bg-slate-50">
                    <p class="text-[10px] font-bold text-slate-400 mb-3 uppercase">Scan to Pay</p>
                    <img src="https://via.placeholder.com/150?text=QR+CODE" class="mx-auto rounded-lg w-32 h-32 object-cover">
                </div>

                <input type="text" id="tid-input" placeholder="Paste Transaction ID (TID)" class="w-full mt-6 p-4 bg-slate-100 border-none rounded-2xl text-center font-bold text-sm focus:ring-2 ring-blue-500 outline-none">
                
                <button onclick="submitTID()" class="w-full mt-4 py-4 bg-green-500 text-white rounded-2xl font-black text-sm btn-3d shadow-lg shadow-green-200">
                    ACTIVE NOW
                </button>
            </div>
            
            <p class="text-center text-[10px] text-slate-400 font-bold mt-6 px-4 leading-relaxed">
                Note: Valid TID is required. Fake submissions lead to permanent ban. Verification takes 1-12 hours.
            </p>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAyXzJ1UUdtWe96NjiQbVCqnWdIv8XakhA",
            authDomain: "silverxtrader.firebaseapp.com",
            projectId: "silverxtrader",
            storageBucket: "silverxtrader.firebasestorage.app",
            messagingSenderId: "46330013690",
            appId: "1:46330013690:web:c2aad241ad7abd49e0e643"
        };
        
        // Initialize Services
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        emailjs.init("zqFa81v7RThJXvikM");

        // --- GLOBAL DATA ---
        let userData = { points: 0, status: 'Free', email: '' };
        let activeBroker = 'qx';
        let activeCardId = null;
        let isProcessing = false;

        const pairs = ["EUR/USD","GBP/USD","USD/JPY","AUD/USD","USD/CAD","EUR/GBP","NZD/USD","USD/CHF","EUR/JPY","GBP/JPY","BTC/USD","ETH/USD","SOL/USD","XRP/USD","LTC/USD","DOGE/USD"];
        
        const adLinks = [
            "https://www.effectivegatecpm.com/zu9fwwufi?key=5c01f6e26f4b9943913f0d36bfa48f6d",
            "https://www.effectivegatecpm.com/m3re02atee?key=cebdb997452acac01a6d39d48dcb0e68",
            "https://www.effectivegatecpm.com/njujpaga3n?key=2636c1fb3975328fd5e16e532dda0482",
            "https://www.effectivegatecpm.com/u03w5rk4?key=d5c708947384bde96b27f42a724b41d9",
            "https://www.effectivegatecpm.com/szh2badub?key=8aef9f0adbfa95686459aaeeea7db26a",
            "https://www.effectivegatecpm.com/wzb0ven1?key=87866ac53935e941e61c53d03338eb0a",
            "https://www.effectivegatecpm.com/d29maviwb?key=f03e146f78029f3a63200d7d63db6e42",
            "https://www.effectivegatecpm.com/p85rfz3v8?key=b50205713bdb8a8e9b85dc14013c31f7"
        ];

        // --- CONTENT DATA ---
        const policyPoints = [
            "1. Signals are generated via AI analysis but do not guarantee 100% market success. Users must trade responsibly.",
            "2. Capital loss is a part of trading risk; SilverX Terminal is not liable for financial losses incurred.",
            "3. Deposits for VIP/Recovery plans are non-refundable once the service activation process begins.",
            "4. Withdrawal requests are processed manually within 1-12 hours to verify genuine ad-viewing activity.",
            "5. Minimum withdrawal threshold is 5000 Points ($5 USDT). Requests below this will be auto-rejected.",
            "6. Usage of VPN, bots, or multiple accounts to farm points will result in an immediate permanent ban.",
            "7. User data is encrypted in Firebase and never shared with third-party brokers or agencies.",
            "8. Recovery sessions aim for high growth but are subject to market volatility conditions.",
            "9. If a recovery target fails completely due to our error, the plan fee is 100% refundable.",
            "10. VIP Status grants ad-free access for 30 days from the moment of Admin activation.",
            "11. Submitting fake Transaction IDs (TIDs) is a fraud attempt and leads to account suspension.",
            "12. SilverX reserves the right to update algorithms and policies to maintain system integrity."
        ];

        const vipRules = [
            "1. ACCESS: Instant signals without any ad waiting time for 30 days.",
            "2. ACCURACY: AI filters activate 'Institutional Mode' providing 99% accuracy.",
            "3. UNLIMITED: No daily signal limits and priority server connection.",
            "4. OTC: Special algorithm access for weekend OTC markets.",
            "5. RECOVERY: Get 2 FREE $20 Recovery Sessions included in your VIP plan.",
            "6. ACTIVATION: Status updates within 12-24 hours of payment verification."
        ];

        const recRules = [
            "1. GOAL: Grow small accounts ($10-$100) using high-frequency AI signals.",
            "2. RISK: Institutional money management applied to minimize drawdown.",
            "3. PROFIT: You keep 100% of the profit generated in the session.",
            "4. REFUND: 100% Fee refund if the daily target is not achieved.",
            "5. PROCESS: Redirects to WhatsApp for session scheduling after payment.",
            "6. VIP BONUS: VIP members can claim $20 sessions for free (Limit: 2)."
        ];

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initContent();
            renderPairs('qx');
            renderPairs('po');
            setInterval(() => {
                document.getElementById('live-clock').innerText = new Date().toLocaleTimeString();
            }, 1000);
        });

        // --- AUTH & ATOMIC PROFILE ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('menu-email').innerText = user.email;
                const userRef = db.collection("users").doc(user.uid);
                
                // Realtime Listener
                userRef.onSnapshot(doc => {
                    if (doc.exists) {
                        userData = doc.data();
                        updateUI();
                    } else {
                        // Atomic Create Profile
                        userRef.set({
                            email: user.email,
                            points: 0,
                            status: "Free",
                            joined: firebase.firestore.FieldValue.serverTimestamp(),
                            lastActive: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
            } else {
                // Redirect to login if needed, for now we assume this is the main protected page
                 window.location.href = "index.html"; // Ensure you have an index.html login page
            }
        });

        function updateUI() {
            document.getElementById('pts').innerText = userData.points || 0;
            const badge = document.getElementById('tier-badge');
            const crown = document.getElementById('vip-icon');
            const vipFreeBadge = document.getElementById('vip-free-badge');

            if (userData.status === "VIP") {
                badge.innerText = "VIP MEMBER";
                badge.className = "px-3 py-1 rounded-full text-[10px] font-black uppercase status-vip";
                crown.classList.add("fa-beat");
                vipFreeBadge.classList.remove("hidden"); // Show Free Recovery Badge
            } else {
                badge.innerText = "FREE";
                badge.className = "px-3 py-1 rounded-full text-[10px] font-black uppercase status-free";
                crown.classList.remove("fa-beat");
                vipFreeBadge.classList.add("hidden");
            }
        }

        // --- RENDERING ---
        function initContent() {
            const pBox = document.getElementById('policy-content');
            policyPoints.forEach(t => pBox.innerHTML += `<div class="p-3 bg-slate-50 rounded-xl text-[11px] font-bold text-slate-600 border-l-4 border-blue-500">${t}</div>`);
            
            const vBox = document.getElementById('vip-rules-content');
            vipRules.forEach(t => vBox.innerHTML += `<div class="p-3 bg-amber-50 rounded-xl text-xs font-bold text-amber-800 border-l-4 border-amber-500">${t}</div>`);

            const rBox = document.getElementById('rec-rules-content');
            recRules.forEach(t => rBox.innerHTML += `<div class="p-3 bg-slate-50 rounded-xl text-xs font-bold text-slate-600 border-l-4 border-blue-500">${t}</div>`);
        }

        function renderPairs(broker) {
            const container = document.getElementById(`${broker}-grid`);
            pairs.forEach((pair, index) => {
                const div = document.createElement('div');
                div.className = "bg-white p-5 rounded-[25px] border border-slate-100 shadow-sm relative overflow-hidden transition-all duration-300";
                div.id = `${broker}-card-${index}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-4 relative z-10">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-[10px] text-slate-500">${pair.substring(0,1)}</div>
                            <h4 class="font-black text-slate-700 text-sm">${pair}</h4>
                        </div>
                        <span class="text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded">96% ACC</span>
                    </div>
                    <div class="ai-chamber mb-4">
                        <div class="matrix-lines"></div>
                        <div class="neon-swirl">
                            <i class="fas fa-microchip text-2xl text-white"></i>
                        </div>
                    </div>
                    <button id="${broker}-btn-${index}" onclick="handleSignalRequest('${broker}', ${index})" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-xs tracking-widest btn-3d relative z-10 shadow-lg">
                        GET AI SIGNAL
                    </button>
                `;
                container.appendChild(div);
            });
        }

        // --- SIGNAL LOGIC ---
        function handleSignalRequest(broker, index) {
            activeCardId = `${broker}-card-${index}`;
            const btn = document.getElementById(`${broker}-btn-${index}`);

            if (isProcessing) return;

            // VIP Check
            if (userData.status === "VIP") {
                generateSignal(activeCardId, btn, true);
            } else {
                startAd(activeCardId, btn);
            }
        }

        function startAd(cardId, btn) {
            const overlay = document.getElementById('ad-layer');
            const frame = document.getElementById('ad-frame');
            const timerTxt = document.getElementById('ad-timer');
            const closeBtn = document.getElementById('ad-close-btn');

            // Pick Random Link & Timer (10s - 30s)
            const randomLink = adLinks[Math.floor(Math.random() * adLinks.length)];
            let timeLeft = Math.floor(Math.random() * (30 - 10 + 1)) + 10;
            
            frame.src = randomLink;
            overlay.style.display = 'flex';
            closeBtn.classList.add('hidden');
            
            const timerInt = setInterval(() => {
                timeLeft--;
                timerTxt.innerText = `WAIT: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(timerInt);
                    timerTxt.innerText = "READY";
                    closeBtn.classList.remove('hidden');
                }
            }, 1000);

            // Close Logic
            window.closeAd = () => {
                overlay.style.display = 'none';
                frame.src = "about:blank"; // Stop ad
                generateSignal(cardId, btn, false);
            };
        }

        function generateSignal(cardId, btn, isVip) {
            isProcessing = true;
            btn.innerText = "ANALYZING...";
            btn.disabled = true;
            btn.classList.remove("bg-slate-900");
            btn.classList.add("bg-slate-400");

            setTimeout(() => {
                // Determine Signal
                const isBuy = Math.random() > 0.5;
                const card = document.getElementById(cardId);
                
                // Visuals
                card.classList.add(isBuy ? 'signal-buy' : 'signal-sell');
                btn.classList.remove("bg-slate-400");
                btn.classList.add(isBuy ? 'bg-green-500' : 'bg-red-500', 'animate-pulse');
                btn.innerText = isBuy ? "CALL (BUY) 1 MIN" : "PUT (SELL) 1 MIN";

                // Add Point (Backend Secure)
                if (!isVip) {
                     db.collection("users").doc(auth.currentUser.uid).update({
                        points: firebase.firestore.FieldValue.increment(1)
                    });
                }

                // Cooldown
                let cooldown = 60;
                const cdInt = setInterval(() => {
                    cooldown--;
                    btn.innerText = `WAIT ${cooldown}s`;
                    if (cooldown <= 0) {
                        clearInterval(cdInt);
                        resetCard(cardId, btn);
                    }
                }, 1000);

            }, 2000); // 2s Analysis Simulation
        }

        function resetCard(cardId, btn) {
            const card = document.getElementById(cardId);
            card.classList.remove('signal-buy', 'signal-sell');
            btn.className = "w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-xs tracking-widest btn-3d relative z-10 shadow-lg";
            btn.innerText = "GET AI SIGNAL";
            btn.disabled = false;
            isProcessing = false;
        }

        // --- PAYMENT & RECOVERY LOGIC ---
        let pendingPlan = "";
        
        function openPayment(planName, price) {
            pendingPlan = planName;
            document.getElementById('pay-plan-name').innerText = planName.replace('_', ' ');
            document.getElementById('pay-amount').innerText = `$${price}.00`;
            document.getElementById('payment-page').style.display = 'block';
        }

        function checkRecovery(amount) {
            // Special Logic: If VIP and Plan is $20, it's free (limit 2 logic would be on admin side mostly, but we redirect)
            if (userData.status === "VIP" && amount === 20) {
                const msg = encodeURIComponent("Hi Admin, I am a VIP Member. I want to claim my FREE $20 Recovery Session.");
                window.location.href = `https://wa.me/923064391353?text=${msg}`;
            } else {
                openPayment(`RECOVERY_$${amount}`, amount);
            }
        }

        function submitTID() {
            const tid = document.getElementById('tid-input').value;
            if (tid.length < 6) { alert("Invalid Transaction ID"); return; }
            
            // Save Payment Request
            db.collection("payments").add({
                userId: auth.currentUser.uid,
                email: userData.email,
                plan: pendingPlan,
                tid: tid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: "pending"
            }).then(() => {
                // Email Alert
                emailjs.send("service_cps9vge", "template_z0z0grc", {
                    user_email: userData.email,
                    type: "PAYMENT: " + pendingPlan,
                    details: "TID: " + tid
                });
                
                alert("Payment Submitted! Status will update in 12-24 hours.");
                closeModal('payment-page');
                
                // Redirect for Recovery
                if (pendingPlan.includes('RECOVERY')) {
                    window.location.href = "https://wa.me/923064391353?text=" + encodeURIComponent(`I have paid for ${pendingPlan} with TID: ${tid}. Please schedule my session.`);
                }
            });
        }

        // --- WITHDRAWAL LOGIC ---
        function handleWithdraw() {
            if (userData.points < 5000) {
                alert("Minimum 5000 Points required for withdrawal.");
                return;
            }
            
            const addr = prompt("Enter your USDT TRC20 Address:");
            if (!addr || addr.length < 10) return;

            // Atomic Withdrawal: Check, Deduct, Record
            const userRef = db.collection("users").doc(auth.currentUser.uid);
            
            db.runTransaction(async (t) => {
                const doc = await t.get(userRef);
                const newPoints = doc.data().points - 5000; // Deduct logic locally calculated
                if (newPoints < 0) throw "Insufficient points";
                
                t.update(userRef, { points: newPoints });
                
                const withdrawRef = db.collection("withdrawals").doc();
                t.set(withdrawRef, {
                    userId: auth.currentUser.uid,
                    email: userData.email,
                    amount: 5,
                    pointsDeducted: 5000,
                    address: addr,
                    status: "pending",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }).then(() => {
                emailjs.send("service_cps9vge", "template_z0z0grc", {
                    user_email: userData.email,
                    type: "WITHDRAWAL REQUEST",
                    details: "Address: " + addr
                });
                alert("Withdrawal Request Sent! Points Deducted.");
            }).catch(err => {
                alert("Transaction Failed: " + err);
            });
        }

        // --- UTILS ---
        function switchTab(t) {
            activeBroker = t;
            document.getElementById('qx-grid').classList.toggle('hidden', t !== 'qx');
            document.getElementById('po-grid').classList.toggle('hidden', t !== 'po');
            document.getElementById('tab-qx').className = t === 'qx' ? 'flex-1 py-3 rounded-xl text-xs font-black bg-white shadow-sm text-slate-800 transition-all' : 'flex-1 py-3 rounded-xl text-xs font-black text-slate-500 transition-all';
            document.getElementById('tab-po').className = t === 'po' ? 'flex-1 py-3 rounded-xl text-xs font-black bg-white shadow-sm text-slate-800 transition-all' : 'flex-1 py-3 rounded-xl text-xs font-black text-slate-500 transition-all';
        }
        
        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function toggleSidebar() { 
            document.getElementById('app-sidebar').classList.toggle('active');
            const overlay = document.getElementById('side-overlay');
            overlay.style.display = overlay.style.display === 'block' ? 'none' : 'block';
        }
    </script>
</body>
</html>
